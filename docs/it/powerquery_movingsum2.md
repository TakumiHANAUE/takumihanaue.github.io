---
layout: default
title: Excel Power Query で移動合計を算出する（その２）
nav_order: 2
parent: IT
---

日ごとの勤務時間データから時間外業務時間の N 日間移動合計 (Moving/Rolling/Running Sum/Total per N days) を算出する。  
ここでは3日間移動合計を算出する。

詳細エディターで直接M言語を書かず、UI操作のみで移動合計を算出する。

## 元データ

| 日付              | 勤務時間 |
| :---------------- | :------- |
| 2022 年 1 月 1 日 | 8.00     |
| 2022 年 1 月 2 日 | 9.00     |
| 2022 年 1 月 3 日 | 10.00    |
| 2022 年 1 月 4 日 | 8.00     |
| 2022 年 1 月 5 日 | 7.70     |
| 2022 年 1 月 6 日 | 8.20     |
| 2022 年 1 月 7 日 | 5.50     |

## 手順

以下の手順で移動合計を算出する。

- 集計開始日列を追加する
- テーブルを列として追加する
- 移動合計集計のための条件列を追加する
- 移動合計を集計する

### 集計開始日列を追加する

列の追加 > カスタム列 から「集計開始日」列を追加する。

- **新しい列名** に「集計開始日」と入力する
- **カスタム列の式** 欄の "=" 右側にカーソルを置く
- **使用できる列** の `[日付]` を選択する
- **挿入** を押す
- **カスタム列の式** に `- #duration(2, 0, 0, 0)` を入力する

なお、**カスタム列の式** に `Date.AddDays([日付], -2)` と入力しても良い。

![「集計開始日」列を追加]({% link docs/it/assets/powerquery_movingsum2_00.png %})

### テーブルを列として追加する

列の追加 > カスタム列 から、「集計開始日」追加後の表を追加する。

- **新しい列名** に `追加されたカスタム` と入力する  
    この例では "追加されたカスタム" は「集計開始日」追加後の表を表している。
    なお、各手順実施後の表の名前は **適用したステップ** 欄から確認できる。  
    ![表の名前]({% link docs/it/assets/powerquery_movingsum2_01.png %})
- 追加した列 ヘッダ部のボタンを押し、**日付**、**勤務時間** を展開する  
    展開後は **日付.1**、**勤務時間.1** として表示される  
    ![列の展開]({% link docs/it/assets/powerquery_movingsum2_02.png %})

この手順により、一つの日付に対してすべての日付・勤務時間（**日付.1**、**勤務時間.1**）が組み合わさった行が作られる。

### 移動合計集計のための条件列を追加する

移動合計は「集計開始日 から 日付 までの勤務時間」の合計を計算するため、この期間を満たす勤務時間のみを絞り込む。

- **日付**以前の勤務時間を表す列を追加する  
    - 列の追加 > 条件列 から以下のように列を追加する（**カスタム**として列追加される）。  
        ![日付以前の勤務時間]({% link docs/it/assets/powerquery_movingsum2_03.png %})
- **集計開始日**以降の勤務時間を表す列を追加する
    - 列の追加 > 条件列 から以下のように列を追加する（**カスタム.1**として列追加される）。  
        ![集計開始日以降の勤務時間]({% link docs/it/assets/powerquery_movingsum2_04.png %})
- 集計対象外の行を除く
    - **カスタム**列（**日付**以前の勤務時間）から null のなっている行をフィルターする  
    ![集計開始日以降の勤務時間]({% link docs/it/assets/powerquery_movingsum2_05.png %})
    - **カスタム.1**列（**集計開始日**以降の勤務時間）から null のなっている行をフィルターする  
    ![集計開始日以降の勤務時間]({% link docs/it/assets/powerquery_movingsum2_05.png %})


### 移動合計を集計する

- 不要な列を削除する  
    **集計開始日**、**日付.1**、**カスタム**、**カスタム.1**を削除する
- ホーム > グループ化 から **勤務時間.1**列を **日付**・**勤務時間**でグループ化（合計）する  
    - グループ可対象の列として **日付**・**勤務時間** を選択する（**グループ化の追加**ボタンで選択欄を追加できる）
    
    ![集計開始日以降の勤務時間]({% link docs/it/assets/powerquery_movingsum2_06.png %})



以上より、移動合計を算出することができた。

![集計開始日以降の勤務時間]({% link docs/it/assets/powerquery_movingsum2_07.png %})
